{% extends "base.html" %}

{% block title %}Belt Vision - Project Settings{% endblock %}
{% block nav_project %}active{% endblock %}

{% block content %}
<h1>Project Settings</h1>
<p>Configure your project information and settings.</p>

<div class="current-settings">
    <h2>Current Settings</h2>
    <table class="settings-table">
        <tr>
            <th>VM Number</th>
            <td id="current_vm_number">-</td>
        </tr>
        <tr>
            <th>Title</th>
            <td id="current_title">-</td>
        </tr>
        <tr>
            <th>Description</th>
            <td id="current_description">-</td>
        </tr>
        <tr>
            <th>IRIS Main Folder</th>
            <td id="current_iris_main_folder">-</td>
        </tr>
        <tr>
            <th>IRIS Classifier Subfolder</th>
            <td id="current_iris_classifier_subfolder">-</td>
        </tr>
        <tr>
            <th>IRIS Model Subfolder</th>
            <td id="current_iris_model_subfolder">-</td>
        </tr>
        <tr>
            <th>CSV Interval (seconds)</th>
            <td id="current_csv_interval_seconds">-</td>
        </tr>
        <tr>
            <th>Last Updated</th>
            <td id="current_updated_at">-</td>
        </tr>
    </table>
    
    <button onclick="toggleEditForm()" class="btn-toggle" id="toggleButton">
        ▼ Edit Settings
    </button>
</div>

<div class="settings-form-container" id="editFormContainer" style="display: none;">
    <form id="projectSettingsForm" onsubmit="saveProjectSettings(event)">
        <div class="form-group">
            <label for="vm_number">VM Number:</label>
            <input type="text" id="vm_number" name="vm_number" required>
            <small>Unique identifier for this virtual machine</small>
        </div>
        
        <div class="form-group">
            <label for="title">Project Title:</label>
            <input type="text" id="title" name="title" required>
            <small>The display name for your project</small>
        </div>
        
        <div class="form-group">
            <label for="description">Description:</label>
            <textarea id="description" name="description" rows="4"></textarea>
            <small>Brief description of your project</small>
        </div>
        
        <div class="form-group">
            <label for="iris_main_folder">IRIS Main Folder:</label>
            <input type="text" id="iris_main_folder" name="iris_main_folder">
            <small>Main folder path for IRIS data</small>
        </div>
        
        <div class="form-group">
            <label for="iris_classifier_subfolder">IRIS Classifier Subfolder:</label>
            <input type="text" id="iris_classifier_subfolder" name="iris_classifier_subfolder">
            <small>Subfolder path for IRIS classifiers</small>
        </div>
        
        <div class="form-group">
            <label for="iris_model_subfolder">IRIS Model Subfolder:</label>
            <input type="text" id="iris_model_subfolder" name="iris_model_subfolder">
            <small>Subfolder path for IRIS models</small>
        </div>
        
        <div class="form-group">
            <label for="csv_interval_seconds">CSV Interval (seconds):</label>
            <input type="number" id="csv_interval_seconds" name="csv_interval_seconds" min="1" value="60">
            <small>Time interval (in seconds) to accumulate data in same CSV file</small>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn-save">Save Settings</button>
            <button type="button" onclick="loadProjectSettings()" class="btn-refresh">Reset Form</button>
        </div>
    </form>
    
    <div id="settingsMessage" class="message" style="display: none;"></div>
</div>

<div class="model-status-section">
    <h2>Model Statuses</h2>
    <table class="settings-table" id="statusTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="statusTableBody">
            <tr>
                <td colspan="3">No statuses found</td>
            </tr>
        </tbody>
    </table>
    
    <button onclick="toggleStatusForm()" class="btn-toggle" id="toggleStatusButton">
        ▼ Add New Status
    </button>
    
    <div class="status-form-container" id="statusFormContainer" style="display: none;">
        <h3 id="statusFormTitle">Add New Status</h3>
        <form id="statusForm" onsubmit="saveStatus(event)">
            <input type="hidden" id="originalStatusId" value="">
            
            <div class="form-group">
                <label for="status_id">ID:</label>
                <input type="number" id="status_id" name="status_id" required>
                <small>Unique identifier for the status</small>
            </div>
            
            <div class="form-group">
                <label for="status_name">Name:</label>
                <input type="text" id="status_name" name="status_name" required>
                <small>Display name for the status</small>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn-save">Save Status</button>
                <button type="button" onclick="cancelStatusEdit()" class="btn-refresh">Cancel</button>
            </div>
        </form>
        
        <div id="statusMessage" class="message" style="display: none;"></div>
    </div>
</div>

<style>
    .btn-toggle {
        margin-top: 20px;
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .btn-toggle:hover {
        background-color: #0056b3;
    }
    
    .settings-form-container {
        margin-top: 20px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #f9f9f9;
    }
    
    .model-status-section {
        margin-top: 40px;
        padding-top: 20px;
        border-top: 2px solid #ddd;
    }
    
    .status-form-container {
        margin-top: 20px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #f9f9f9;
    }
    
    .settings-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }
    
    .settings-table th,
    .settings-table td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: left;
    }
    
    .settings-table thead th {
        background-color: #f0f0f0;
        font-weight: bold;
    }
    
    .btn-action {
        padding: 5px 10px;
        margin-right: 5px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
    }
    
    .btn-edit {
        background-color: #28a745;
        color: white;
    }
    
    .btn-edit:hover {
        background-color: #218838;
    }
    
    .btn-delete {
        background-color: #dc3545;
        color: white;
    }
    
    .btn-delete:hover {
        background-color: #c82333;
    }
    
    .message.success {
        color: #28a745;
        background-color: #d4edda;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
    }
    
    .message.error {
        color: #dc3545;
        background-color: #f8d7da;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block additional_scripts %}
<script>
    let isEditingStatus = false;
    
    function toggleStatusForm() {
        const formContainer = document.getElementById('statusFormContainer');
        const toggleButton = document.getElementById('toggleStatusButton');
        
        if (formContainer.style.display === 'none') {
            formContainer.style.display = 'block';
            toggleButton.textContent = '▲ Hide Form';
        } else {
            formContainer.style.display = 'none';
            toggleButton.textContent = '▼ Add New Status';
            cancelStatusEdit();
        }
    }
    
    function cancelStatusEdit() {
        isEditingStatus = false;
        document.getElementById('statusFormTitle').textContent = 'Add New Status';
        document.getElementById('statusForm').reset();
        document.getElementById('originalStatusId').value = '';
        document.getElementById('status_id').disabled = false;
        const messageDiv = document.getElementById('statusMessage');
        messageDiv.style.display = 'none';
    }
    
    async function loadModelStatuses() {
        try {
            const response = await fetch('/model-statuses');
            if (response.ok) {
                const statuses = await response.json();
                const tbody = document.getElementById('statusTableBody');
                
                if (statuses.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3">No statuses found</td></tr>';
                } else {
                    tbody.innerHTML = statuses.map(status => `
                        <tr>
                            <td>${status.id}</td>
                            <td>${status.name}</td>
                            <td>
                                <button class="btn-action btn-edit" onclick="editStatus(${status.id}, '${status.name.replace(/'/g, "\\'")}')">Edit</button>
                                <button class="btn-action btn-delete" onclick="deleteStatus(${status.id})">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                }
            }
        } catch (error) {
            console.error('Error loading model statuses:', error);
        }
    }
    
    function editStatus(id, name) {
        isEditingStatus = true;
        document.getElementById('statusFormTitle').textContent = 'Edit Status';
        document.getElementById('originalStatusId').value = id;
        document.getElementById('status_id').value = id;
        document.getElementById('status_name').value = name;
        
        // Show the form if it's hidden
        const formContainer = document.getElementById('statusFormContainer');
        if (formContainer.style.display === 'none') {
            toggleStatusForm();
        }
        
        // Scroll to form
        formContainer.scrollIntoView({ behavior: 'smooth' });
    }
    
    async function saveStatus(event) {
        event.preventDefault();
        
        const statusId = parseInt(document.getElementById('status_id').value);
        const statusName = document.getElementById('status_name').value.trim();
        const originalId = document.getElementById('originalStatusId').value;
        
        const statusData = {
            id: statusId,
            name: statusName
        };
        
        try {
            let response;
            if (isEditingStatus && originalId) {
                // Update existing status
                response = await fetch(`/model-status/${originalId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(statusData)
                });
            } else {
                // Create new status
                response = await fetch('/model-status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(statusData)
                });
            }
            
            const result = await response.json();
            const messageDiv = document.getElementById('statusMessage');
            messageDiv.style.display = 'block';
            
            if (response.ok) {
                messageDiv.textContent = result.message || 'Status saved successfully!';
                messageDiv.className = 'message success';
                
                setTimeout(() => {
                    loadModelStatuses();
                    cancelStatusEdit();
                    messageDiv.style.display = 'none';
                }, 1500);
            } else {
                messageDiv.textContent = 'Error: ' + (result.error || 'Failed to save status');
                messageDiv.className = 'message error';
            }
        } catch (error) {
            const messageDiv = document.getElementById('statusMessage');
            messageDiv.style.display = 'block';
            messageDiv.textContent = 'Error saving status: ' + error.message;
            messageDiv.className = 'message error';
        }
    }
    
    async function deleteStatus(id) {
        if (!confirm(`Are you sure you want to delete status with ID ${id}?`)) {
            return;
        }
        
        try {
            const response = await fetch(`/model-status/${id}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                loadModelStatuses();
            } else {
                const result = await response.json();
                alert('Error: ' + (result.error || 'Failed to delete status'));
            }
        } catch (error) {
            alert('Error deleting status: ' + error.message);
        }
    }

    function toggleEditForm() {
        const formContainer = document.getElementById('editFormContainer');
        const toggleButton = document.getElementById('toggleButton');
        
        if (formContainer.style.display === 'none') {
            formContainer.style.display = 'block';
            toggleButton.textContent = '▲ Hide Edit Form';
        } else {
            formContainer.style.display = 'none';
            toggleButton.textContent = '▼ Edit Settings';
        }
    }

    async function loadProjectSettings() {
        try {
            const response = await fetch('/project-settings');
            if (response.ok) {
                const settings = await response.json();
                
                // Populate form
                document.getElementById('vm_number').value = settings.vm_number || '';
                document.getElementById('title').value = settings.title || '';
                document.getElementById('description').value = settings.description || '';
                document.getElementById('iris_main_folder').value = settings.iris_main_folder || '';
                document.getElementById('iris_classifier_subfolder').value = settings.iris_classifier_subfolder || '';
                document.getElementById('iris_model_subfolder').value = settings.iris_model_subfolder || '';
                document.getElementById('csv_interval_seconds').value = settings.csv_interval_seconds || 60;
                
                // Populate current settings display
                document.getElementById('current_vm_number').textContent = settings.vm_number || '-';
                document.getElementById('current_title').textContent = settings.title || '-';
                document.getElementById('current_description').textContent = settings.description || '-';
                document.getElementById('current_iris_main_folder').textContent = settings.iris_main_folder || '-';
                document.getElementById('current_iris_classifier_subfolder').textContent = settings.iris_classifier_subfolder || '-';
                document.getElementById('current_iris_model_subfolder').textContent = settings.iris_model_subfolder || '-';
                document.getElementById('current_csv_interval_seconds').textContent = settings.csv_interval_seconds || '60';
                
                if (settings.updated_at) {
                    const date = new Date(settings.updated_at);
                    document.getElementById('current_updated_at').textContent = date.toLocaleString();
                } else {
                    document.getElementById('current_updated_at').textContent = '-';
                }
            }
        } catch (error) {
            console.error('Error loading project settings:', error);
        }
    }

    async function saveProjectSettings(event) {
        event.preventDefault();
        
        const formData = {
            vm_number: document.getElementById('vm_number').value,
            title: document.getElementById('title').value,
            description: document.getElementById('description').value,
            iris_main_folder: document.getElementById('iris_main_folder').value,
            iris_classifier_subfolder: document.getElementById('iris_classifier_subfolder').value,
            iris_model_subfolder: document.getElementById('iris_model_subfolder').value,
            csv_interval_seconds: parseInt(document.getElementById('csv_interval_seconds').value) || 60
        };

        try {
            const response = await fetch('/project-settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            const result = await response.json();
            const messageDiv = document.getElementById('settingsMessage');
            messageDiv.style.display = 'block';
            
            if (response.ok) {
                messageDiv.textContent = 'Settings saved successfully!';
                messageDiv.className = 'message success';
                
                // Reload the current settings display
                setTimeout(() => {
                    loadProjectSettings();
                    messageDiv.style.display = 'none';
                }, 2000);
            } else {
                messageDiv.textContent = 'Error: ' + (result.error || 'Failed to save settings');
                messageDiv.className = 'message error';
            }
        } catch (error) {
            const messageDiv = document.getElementById('settingsMessage');
            messageDiv.style.display = 'block';
            messageDiv.textContent = 'Error saving settings: ' + error.message;
            messageDiv.className = 'message error';
        }
    }
    
    // Load settings on page load
    window.onload = function() {
        loadProjectSettings();
        loadModelStatuses();
    };
</script>
{% endblock %}
