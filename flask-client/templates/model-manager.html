{% extends "base.html" %}

{% block title %}Belt Vision - Models & Classifiers{% endblock %}
{% block nav_models %}active{% endblock %}

{% block additional_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/project-settings.css') }}">
{% endblock %}

{% block content %}
<h1>ML Model and Classifier Manager</h1>

    <button id="addModelBtn" class="btn-toggle" type="button">▼ Add a new model or classifier</button><br/><br/>

    <div class="settings-form-container" id="uploadForm" style="display:none;">
        <h2>Upload New Model or Classifier</h2>
        <form action="{{ url_for('ml.upload_model') }}" method="post" enctype="multipart/form-data">
            <div class="form-group">
                <label for="model_file">Select Model File:</label>
                <input type="file" id="model_file" name="model_file" required>
            </div>

            <div class="form-group">
                <label for="name">Model Name:</label>
                <input type="text" id="name" name="name" placeholder="e.g., yolov5" required>
            </div>

            <div class="form-group">
                <label for="version">Version:</label>
                <input type="text" id="version" name="version" placeholder="e.g., 1.0.0" required>
            </div>

            <div style="display: flex; gap: 20px;">
                <div class="form-group" style="flex: 1;">
                    <label for="model_type">Model Type:</label>
                    <select id="model_type" name="model_type" required>
                        <option value="">Select type</option>
                        <option value="yolo">YOLO</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group" style="flex: 1;">
                    <label for="category">Category:</label>
                    <select id="category" name="category" required>
                        <option value="model">Model</option>
                        <option value="classifier">Classifier</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="description">Description (optional):</label>
                <textarea id="description" name="description" rows="3" placeholder="Optional description"></textarea>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-save">Save</button>
                <button type="button" class="btn-cancel" onclick="cancelUploadForm()">Cancel</button>
            </div>
        </form>
    </div>

    <h2>Available Models</h2>
    <table class="settings-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Version</th>
                <th>Type</th>
                <th>Description</th>
                <th>Created At</th>
                <th>Updated At</th>
                <th>Default</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for model in models %}
            <tr>
                <td>{{ model[0] }}</td>
                <td>{{ model[1] }}</td>
                <td>{{ model[2] }}</td>
                <td>{{ model[3] }}</td>
                <td>{{ model[4] or 'N/A' }}</td>
                <td>{{ model[5] }}</td>
                <td>{{ model[6] }}</td>
                <td>
                    <input type="checkbox" class="default-model-checkbox" 
                           data-model-id="{{ model[1] }}:{{ model[2] }}" 
                           onchange="setDefaultModel(this)">
                </td>
                <td>
                    <form action="{{ url_for('ml.delete_model', model_id=model[0]) }}" method="post" style="display:inline;">
                        <button type="submit" class="btn-action btn-delete" onclick="return confirm('Are you sure you want to delete this model?');">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if not models %}
    <p>No models uploaded yet.</p>
    {% endif %}

    <h2>Available Classifiers</h2>
    <table class="settings-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Version</th>
                <th>Type</th>
                <th>Description</th>
                <th>Created At</th>
                <th>Updated At</th>
                <th>Default</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for classifier in classifiers %}
            <tr>
                <td>{{ classifier[0] }}</td>
                <td>{{ classifier[1] }}</td>
                <td>{{ classifier[2] }}</td>
                <td>{{ classifier[3] }}</td>
                <td>{{ classifier[4] or 'N/A' }}</td>
                <td>{{ classifier[5] }}</td>
                <td>{{ classifier[6] }}</td>
                <td>
                    <input type="checkbox" class="default-classifier-checkbox" 
                           data-classifier-id="{{ classifier[1] }}:{{ classifier[2] }}" 
                           onchange="setDefaultClassifier(this)">
                </td>
                <td>
                    <form action="{{ url_for('ml.delete_model', model_id=classifier[0]) }}" method="post" style="display:inline;">
                        <button type="submit" class="btn-action btn-delete" onclick="return confirm('Are you sure you want to delete this classifier?');">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if not classifiers %}
    <p>No classifiers uploaded yet.</p>
    {% endif %}
{% endblock %}

{% block additional_scripts %}
    <script>
        document.getElementById('addModelBtn').addEventListener('click', function() {
            const form = document.getElementById('uploadForm');
            const button = document.getElementById('addModelBtn');
            if (form.style.display === 'none') {
                form.style.display = 'block';
                button.textContent = '▲ Hide Form';
            } else {
                form.style.display = 'none';
                button.textContent = '▼ Add a new model or classifier';
            }
        });
        
        function cancelUploadForm() {
            const form = document.getElementById('uploadForm');
            const button = document.getElementById('addModelBtn');
            form.style.display = 'none';
            button.textContent = '▼ Add a new model or classifier';
            // Reset the form
            document.querySelector('#uploadForm form').reset();
        }

        // Handle default model selection
        function setDefaultModel(checkbox) {
            if (checkbox.checked) {
                // Uncheck all other model checkboxes
                document.querySelectorAll('.default-model-checkbox').forEach(cb => {
                    if (cb !== checkbox) cb.checked = false;
                });
                // Store in localStorage
                localStorage.setItem('defaultModel', checkbox.dataset.modelId);
            } else {
                localStorage.removeItem('defaultModel');
            }
        }

        // Handle default classifier selection
        function setDefaultClassifier(checkbox) {
            if (checkbox.checked) {
                // Uncheck all other classifier checkboxes
                document.querySelectorAll('.default-classifier-checkbox').forEach(cb => {
                    if (cb !== checkbox) cb.checked = false;
                });
                // Store in localStorage
                localStorage.setItem('defaultClassifier', checkbox.dataset.classifierId);
            } else {
                localStorage.removeItem('defaultClassifier');
            }
        }

        // Load saved defaults on page load
        window.addEventListener('DOMContentLoaded', function() {
            const defaultModel = localStorage.getItem('defaultModel');
            const defaultClassifier = localStorage.getItem('defaultClassifier');

            if (defaultModel) {
                document.querySelectorAll('.default-model-checkbox').forEach(cb => {
                    if (cb.dataset.modelId === defaultModel) {
                        cb.checked = true;
                    }
                });
            }

            if (defaultClassifier) {
                document.querySelectorAll('.default-classifier-checkbox').forEach(cb => {
                    if (cb.dataset.classifierId === defaultClassifier) {
                        cb.checked = true;
                    }
                });
            }
        });
    </script>
{% endblock %}