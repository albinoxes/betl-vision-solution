{% extends "base.html" %}

{% block title %}Belt Vision - Home{% endblock %}
{% block nav_home %}active{% endblock %}

{% block content %}
<div class="project-info">
    <h1 id="projectTitle">Belt Vision</h1>
    <p id="projectDescription">Monitor active video processing threads.</p>
    <p class="vm-info"><strong>VM Number:</strong> <span id="vmNumber">-</span></p>
</div>

<h2>Server Status</h2>
<button onclick="refreshServerStatus()">Refresh</button><br/><br/>
<table border="1" id="serverStatusTable" style="margin-bottom: 30px;">
    <thead>
        <tr>
            <th>Server Name</th>
            <th>Status</th>
            <th>Availability</th>
        </tr>
    </thead>
    <tbody id="serverStatusTableBody">
        {% if servers %}
            {% for server in servers %}
            <tr>
                <td>{{ server.name }}</td>
                <td class="status-badge status-{{ server.status }}">{{ server.status }}</td>
                <td style="text-align: center;">
                    {% if server.available %}
                        <span style="color: green; font-weight: bold;">✓ Online</span>
                    {% else %}
                        <span style="color: red; font-weight: bold;">✗ Offline</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        {% else %}
            <tr>
                <td colspan="3" style="text-align:center;">No servers configured</td>
            </tr>
        {% endif %}
    </tbody>
</table>

<h2>Active Video Threads</h2>
<button onclick="refreshThreads()">Refresh</button><br/><br/>
<table border="1" id="activeThreadsTable">
    <thead>
        <tr>
            <th>Thread ID</th>
            <th>Device Type</th>
            <th>Device ID</th>
            <th>Model</th>
            <th>Classifier</th>
            <th>Settings</th>
            <th>Status</th>
            <th>Processed Frames</th>
            <th>Uptime (seconds)</th>
        </tr>
    </thead>
    <tbody id="threadsTableBody">
        <tr>
            <td colspan="9" style="text-align:center;">No active threads</td>
        </tr>
    </tbody>
</table>
{% endblock %}

{% block additional_scripts %}
<script>
    async function loadProjectInfo() {
        try {
            const response = await fetch('/project-settings');
            if (response.ok) {
                const settings = await response.json();
                document.getElementById('projectTitle').textContent = settings.title || 'Belt Vision';
                document.getElementById('projectDescription').textContent = settings.description || 'Monitor active video processing threads.';
                document.getElementById('vmNumber').textContent = settings.vm_number || '-';
            }
        } catch (error) {
            console.error('Error loading project info:', error);
        }
    }

    async function refreshServerStatus() {
        try {
            const response = await fetch('/health/servers');
            const servers = await response.json();
            const tableBody = document.getElementById('serverStatusTableBody');
            tableBody.innerHTML = '';
            
            if (Object.keys(servers).length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">No servers configured</td></tr>';
            } else {
                for (const [serverName, status] of Object.entries(servers)) {
                    const row = document.createElement('tr');
                    const isAvailable = status === 'available';
                    const statusBadgeClass = `status-badge status-${status}`;
                    
                    row.innerHTML = `
                        <td>${serverName}</td>
                        <td class="${statusBadgeClass}">${status}</td>
                        <td style="text-align: center;">
                            ${isAvailable 
                                ? '<span style="color: green; font-weight: bold;">✓ Online</span>' 
                                : '<span style="color: red; font-weight: bold;">✗ Offline</span>'}
                        </td>
                    `;
                    tableBody.appendChild(row);
                }
            }
        } catch (error) {
            console.error('Error fetching server status:', error);
        }
    }

    async function refreshThreads() {
        try {
            const response = await fetch('/active-threads');
            conServerStatus();
        refreshThreads();
        
        // Auto-refresh server status every 10 seconds
        setInterval(refreshServerStatus, 10000);
        
        // Auto-refresh threads every 5 seconds
        setInterval(refreshThreads, 5000ds = await response.json();
            const tableBody = document.getElementById('threadsTableBody');
            tableBody.innerHTML = '';
            
            if (threads.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" style="text-align:center;">No active threads</td></tr>';
            } else {
                threads.forEach(thread => {
                    const row = document.createElement('tr');
                    const statusColor = thread.running ? (thread.status === 'running' ? '#90EE90' : '#FFD700') : '#FFB6C6';
                    row.innerHTML = `
                        <td>${thread.thread_id}</td>
                        <td>${thread.device_type}</td>
                        <td>${thread.device_id}</td>
                        <td>${thread.model_id}</td>
                        <td>${thread.classifier_id}</td>
                        <td>${thread.settings_id}</td>
                        <td style="background-color:${statusColor};">${thread.status}</td>
                        <td>${thread.frame_count}</td>
                        <td>${thread.uptime}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }
        } catch (error) {
            console.error('Error fetching threads:', error);
        }
    }
    
    // Initial load
    window.onload = function() {
        loadProjectInfo();
        refreshThreads();
    };
</script>
{% endblock %}
